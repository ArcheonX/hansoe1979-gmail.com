@{
    ViewData["Title"] = "IDP";
    ViewData["MainTitle"] = "My-IDP-Review";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@model LDMS.ViewModels.LDMS_T_IDP
<div class="panel panel-primary" style="margin-top:-15px;width:100%;">
    <div class="panel panel-default" style="width:100%;border-width:thin;border-style:solid;">
        <div class="panel-body" style="width:100%;">
            <form id="frmMain" class="form" method="post" enctype="multipart/form-data" style="width:100%">
                @Html.AntiForgeryToken()
                @if (Model != null)
                {
                    <input type="hidden" id="hID" name="hID" value=@Model.ID />
                    <input type="hidden" id="hSubTopicID" name="hSubTopicID" value=@Model.ID_SubTopic />
                    <input type="hidden" id="hID_ReviewHeadCurrent" name="hID_ReviewHeadCurrent" value="" />
                }
                else
                {
                    <input type="hidden" id="hID_ReviewHeadCurrent" name="hID_ReviewHeadCurrent" value="" />
                }
                <div class="form-horizontal" style="margin-top:25px">
                    <div class="row form-group">
                        <div class="col-sm-8 col-md-8">
                            <span class="pull-left Topic">
                                <label class="LabelCaption"></label>
                            </span>
                        </div>

                        <div class="col-sm-2 col-md-2 offset-8">
                            <a id="btnBack" class="btn btn-outline-danger inactive waves-effect waves-light" style="width:70%;" onclick="window.location.href = '@Url.Action("Index", "IDP")';">
                                <img style="width:25px;height:20px" src="~/assets/images/svg/icon-l-red.svg" />&nbsp;&nbsp;Back
                            </a>
                        </div>
                        <div class="col-sm-1 col-md-1" style="margin-left:-25px">
                            <!-- <a id="btnSave" class="btn btn-info waves-effect waves-light" style="width:100%; color:white" onclick="UpdateCoaching()">Save</a>-->
                        </div>

                    </div>
                    <div class="row form-group">
                        <div class="col-sm-1 col-md-1">
                            <div class="user-profile-coaching">
                                <div class="profile-img">
                                    <img src='@Url.Content(@HttpContextAccessor.HttpContext.Request.Cookies["FACEIMAGE"])' alt="user" />
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4 col-md-4" style="margin-top:20px; margin-left:30px">
                            <div class="profile-text">
                                <a aria-expanded="false">Name : @Model.EmployeeName </a>
                            </div>
                            <div class="profile-text">
                                <a aria-expanded="false">Position :@Model.Position</a>
                            </div>
                            <div class="profile-text">
                                <a aria-expanded="false">Service (Year) : 5 </a>
                            </div>
                            <div class="profile-text">
                                <a aria-expanded="false">IDP Time Line : 1 year 1 month 5 Day </a>
                            </div>
                            <div class="profile-text">
                                <a aria-expanded="false">IDP Start : @Model.IDP_StartDate </a>
                            </div>
                            <div class="profile-text">
                                <a aria-expanded="false">IDP End : @Model.IDP_EndDate</a>
                            </div>
                            <div class="profile-text">
                                <a aria-expanded="false">IDP Status : @Model.IDP_StatusName </a>
                            </div>
                        </div>

                        <div id="divSubTopic">
                            
                        </div>
                    </div>


                    <div class="row form-group">
                        <div class="col-sm-1 col-md-4">
                            <span class="pull-right">
                                <label class="LabelCaption"></label>
                            </span>
                        </div>
                        <div class="col-sm-1 col-md-4 offset-6">
                            <span class="pull-right">
                                <label class="LabelCaption">Last Update : </label>
                            </span>
                        </div>
                        <div class="col-sm-1 col-md-2">
                            <span class="pull-left">
                                <label class="LabelCaption">@Model.UpdateDate</label>
                            </span>
                        </div>

                    </div>

                </div>
                <div style="border-width:thin; border-style:solid; margin-left:0px; margin-top: 5px; margin-bottom:5px; width:100%;display:block"></div>

                <div id="divHeader" style="margin-top:25px; margin-left:10px; display:none;">

                </div>
                <div id="divReview" style="margin-top:25px; margin-left:10px; display:none; overflow-y:auto; height:600px"></div>


                <div id="divPost" style="margin-top:25px; margin-left:10px; display:block">
                    <div id="div" style="border-width:thin; border-style:solid; background-color:#f6f6f6; margin-left:5px; display:block; margin-top: 0px; margin-bottom:20px; width:99%;display:block">
                        <div class="row form-group">
                            <div class="col-sm-2 col-md-2" style="margin-left:5px; margin-top:20px; position:relative">
                                <label class="LabelCaption pull-left" style="color:#1c94c4">Write Post</label>
                            </div>
                        </div>
                    </div>
                    <div id="div" style="border-width:thin; border-style:solid; margin-left:5px; display:block; margin-top: -20px; margin-bottom:20px; width:99%;display:block">
                        <div class="row form-group">
                            <div class="col-sm-10 col-md-10" style="margin-top:20px; margin-left:50px; width:80%">
                                <textarea id="txtTopicPost"
                                          name="txtTopicPost"
                                          rows="6" style="width:100%">
                                    </textarea>
                            </div>
                            <div class="col-sm-1 col-md-1" style="margin-top:8em; width:80%">
                                <span class="pull-left">
                                    <a id="btnPost" class="btn btn-outline-primary waves-effect waves-light" onclick="SavePost()" style="width:100%;">
                                    <img style="width:25px;height:20px" src="~/assets/images/svg/right.svg" />&nbsp;&nbsp;Post</a>
                                </span>
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col-sm-2 col-md-2 offset-7" style="margin-top:10px; width:80%">
                                <span class="pull-left">
                                    <!--<a id="btnAttach" class="btn btn-info waves-effect waves-light" style="width:100%; color:white">Attach</a>-->
                                    <a id="aFile" target="_blank"></a>
                                    <input type="hidden" id="hdfile" name="ofile" />
                                    <input type="file" id="fiAttachFile" name="fileAttach" accept="application/pdf,application/vnd.ms-excel,application/vnd.ms-word" />
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>
@section Scripts{
    <style type="text/css">
        .form-group {
            position: relative;
            background-size: cover;
        }

        .Topic {
            position: absolute;
            background-size: cover;
            left: 34em;
            margin-top: 10px;
        }

        .user-profile-coaching {
            margin-bottom: 1.5rem;
        }

        .user-profile-coaching .profile-img {
                width: 120px;
                height: 120px;
                padding-top: 15px;
                padding-left: 15px;
                border-radius: 100%
            }

        .user-profile-coaching .profile-img img {
                    width: 100%;
                    height: 100%;
                    border-radius: 100%
                }

        .user-profile-coaching .profile-text {
                padding: 5px 0px;
                position: relative
            }

        .user-profile-coaching .profile-text > a {
                    width: 100%;
                    padding: 6px 30px;
                    display: block
                }

        .user-profile-coaching .profile-text > a:after {
                        position: absolute;
                        right: 20px;
                        top: 20px
                    }

     

    </style>
    <script type="text/javascript">
        $(document).ready(function () {
            //alert('SubTopicID : ' + $('#hSubTopicID').val());

            
            LoadIDPReviewHead($('#hSubTopicID').val());
            LoadSubTopicDetail($('#hSubTopicID').val());

        });

         function VisiblePanel(e) {
            //alert(document.getElementById("btnTargetAudience").className);

            if (e.className === "fa fa-angle-up") {
                e.className = "fa fa-angle-down";
            }
            else {
                e.className = "fa fa-angle-up";
            }
        }


         function SavePost() {

            alert('SavePost : ' + $('#hID_ReviewHeadCurrent').val());
            if ($('#hID_ReviewHeadCurrent').val() != "") {

                PostReviewDetail($('#hID_ReviewHeadCurrent').val());
            }
            else {
                SaveReviewHeader();
            }
        }

        function SaveReviewHeader() {
            alert('SaveReviewHeader');
            var input = document.getElementById('fiAttachFile');
            var files = input.files[0];
            var formData = new FormData();

            formData.append("ID_IDP_SubTopic", $('#hSubTopicID').val());
            formData.append("EmployeeReport", $('#txtTopicPost').val());
            //formData.append("Topic", $('#txtTopic').val());
            formData.append("fileAttach", files);


            $.ajax(
                {
                    url: "/IDP/InsertReviewHead",
                    type: "POST",
                    dataType: "JSON",
                    data:formData,
                    processData: false,
                    contentType: false,
                success: function (e) {
                    //alert('Save Review : ID_IDP_ReviewHead ' + e.ID);
                    //$('#hID_IDP_ReviewHead').val(e.ID);
                    window.location.href = '@Url.Content("~/IDP/Detail/")' + $('#hSubTopicID').val();
                },
             }
         )
        }

        function PostReviewDetail(ID) {

            var input = document.getElementById('fiAttachFile');
            var files = input.files[0];
            var formData = new FormData();
            formData.append("ID_IDP_SubTopic",  $('#hSubTopicID').val());
            formData.append("ID_IDP_ReviewHead", ID);
            formData.append("PostDetail", $('#txtTopicPost').val());
            formData.append("fileAttach", files);

            $.ajax(
                {
                    url: "/IDP/InsertReviewDetail",
                    type: "POST",
                    dataType: "JSON",
                    data:formData,
                    processData: false,
                    contentType: false,
                success: function (e) {

                    alert('Post Completed');
                    //$('#txtTopicPost').val('');
                    window.location.href = '@Url.Content("~/IDP/Detail/")' + $('#hSubTopicID').val();
                    //UploadFile($('#hID').val());
                },
             }
         )
        }

        function LoadSubTopicDetail(ID) {
            //alert('LoadSubTopicDetail ' + ID);
            $.ajax(
                {
                    url: "/IDP/GetSubTopicsID",
                    type: "POST",
                    data: {
                        ID_IDP_SubTopic  : ID
                    },
                   
                success: function (e) {
                    if (e) {
                        RenderSubTopicDetail(e);
                    }
                },
                }
            )
        }


        function RenderSubTopicDetail(e) {
            var html = '<div class="col-sm-5 col-md-10" style="margin-top:20px; margin-left:3em">'+
                                '<div class="profile-text">'+
                                 '<a aria-expanded="false" style="font-weight: bold">Development Improvement Topic</a>'+
                                '</div>'+
                                '<div class="profile-text">'+
                                    '<a aria-expanded="false">'+ e.DevelopementTopic +'</a>'+
                                '</div>'+
                                '<div class="profile-text" style="font-weight: bold">'+
                                    '<a aria-expanded="false">Expected Outcome</a>'+
                                '</div>'+
                                '<div class="profile-text">'+
                                    '<a aria-expanded="false">'+ e.TopicExpectedOutcom +'</a>'+
                                '</div>'+
                                '<div class="profile-text">'+
                                    '<a aria-expanded="false" style="font-weight: bold">How to Develop? :</a>'+ e.HowToDevelopment  +' '+
                                '</div>'+
                                '<div class="profile-text">'+
                                    '<a aria-expanded="false" style="font-weight: bold">Measurement Outcome : </a> '+ e.ExpectedOutcom +' '+
                                '</div>'+
                                '<div class="profile-text">'+
                                    '<a aria-expanded="false" style="font-weight: bold">By When : </a> '+ e.ByWhen +' '+
                                '</div>'+

                                '<div class="profile-text">'+
                                    '<a aria-expanded="false" style="font-weight: bold">Status : </a> '+ e.SubTopicStatusName +' '+
                                '</div>'+
                '</div>'

            $('#divSubTopic').append(html);
        }


        function LoadIDPReviewHead(ID) {
            $.ajax(
                {
                    url: "/IDP/GetIDPReviewHead",
                    type: "POST",
                    data: {
                        'ID_IDP_SubTopic'  : ID
                },
                success: function (e) {
                    if (e) {
                        RenderIDPReviewHead(e);
                    }
                },
                }
            )
        }

        function RenderIDPReviewHead(e) {
          
            $('#divHeader').attr("style", "display:block");
            $("#divHeader").empty();
            var html = '';
            for (var i = 0; i < e.length; i++) {

                //alert("Header : " + i);
                var strColor = "#f6f6f6;";
                if (e[i].ReviewStatus == "0") {
                    strColor = "#5e676d;";
                }
                else {
                    $('#hID_ReviewHeadCurrent').val(e[i].ID);
                }

                html += '<div id="divH_' + i + '"style="border-width:thin; border-style:solid; background-color:' + strColor + ' margin-left:5px; margin-top: 0px; margin-bottom:20px; width:99%; display:block;">' +
                                  '<div class="row form-group">' +
                                    '<div class="col-sm-1 col-md-1" style="margin-top:20px; position:relative">' +
                                        '<label class="LabelCaption pull-right" style="color:#1c94c4">' + (i+1) + ' Review</label>' +
                                    '</div>' +
                                    ' <div class="col-sm-1 col-md-1 offset-10" style="margin-top:20px; position:relative">'+
                                        '<a href="#dbody_'+ i + '" id="btnReview_'+ i + '"data-toggle="collapse"  onclick="VisiblePanel(this)" style="padding-left:35px; color:#1c94c4; font-size:36px;" class="fa fa-angle-up"></a>' +
                                    '</div>'+
                                   '</div>' +
                                   '</div>' +
                                   '<div id="dbody_'+ i +'"class="collapse show">'+
                                        '<div id="div" style="width:99%;display:block;">' +
                                            '<div class="row form-group">' +
                                                '<div class="col-sm-11 col-md-11" style="margin-top:20px; margin-left:50px; width:80%">' +
                                                //'<textarea id="txtTopicReport" name="txtTopicReport" rows="10" style="width:100%"></textarea>'+
                                                '<label class="LabelCaption pull-left">' + e[i].EmployeeReport + '</label>' +
                                                '</div>' +
                                            '</div>' +
                                            '<div class="row form-group">' +
                                                '<div class="col-sm-2 col-md-2" style="margin-top:10px; margin-left:50px; width:80%">' +
                                                    '<span class="pull-left">' +
                                                    '<label class="LabelCaption pull-right">File Attach : </label>' +
                                                    '</span>' +
                                                '</div>' +
                                                '<div class="col-sm-8 col-md-8" style="margin-top:10px; width:80%">' +
                                                '<span class="pull-left">' +
                                                    '<a href="' + e[i].AttachFilePath + '">' + e[i].AttachFileName + '</a>' +
                                                 '</span>' +
                                                '</div>' +
                                            '</div>' +
                                        '<div class="row form-group">' +
                                            '<div class="col-sm-2 col-md-2" style="margin-top:10px; margin-left:50px; width:80%">' +
                                                '<span class="pull-left">' +
                                                '<label class="LabelCaption pull-right">Post Date : </label>' +
                                                '</span>' +
                                             '</div>' +
                                            '<div class="col-sm-4 col-md-4" style="margin-top:10px;">' +
                                                '<span class="pull-left">' +
                                                '<label class="LabelCaption pull-right">' + e[i].PostDate + '</label>' +
                                                '</span>' +
                                            '</div>' +
                                        '</div>' +
                                    '</div>' 
                    for (var j = 0; j < e[i].listDetail.length; j++)
                    {
                        if (e[i].listDetail[j].PostBy_EmployeeID === CookiesController.getCookie("EMPLOYEEID")) {
                            html += '<div id="div" style="border-width:thin; border-style:solid; margin-left:5px; display:block; margin-top: 20px; margin-bottom:20px; width:99%;display:block">' +
                                        '<div class="row form-group">' +
                                            '<div class="col-sm-11 col-md-11" style="margin-top:20px; margin-left:50px; width:80%">' +
                                                 '<label class="LabelCaption pull-left">' + e[i].listDetail[j].PostDetail + '</label>' +
                                            '</div>' +
                                        '</div>' +
                                        '<div class="row form-group">' +
                                            '<div class="col-sm-1 col-md-2" style="margin-top:10px; margin-left:50px; width:80%">' +
                                                '<span class="pull-left">' +
                                                    '<label class="LabelCaption pull-right">File Attach : </label>' +
                                                '</span>' +
                                            '</div>' +
                                            '<div class="col-sm-8 col-md-8" style="margin-top:10px; width:80%">' +
                                                '<span class="pull-left">' +
                                                    '<a href="' + e[i].listDetail[j].AttachFilePath + '">' + e[i].listDetail[j].AttachFileName + '</a>' +
                                                '</span>' +
                                            '</div>' +
                                        '</div>' +
                                        '<div class="row form-group">' +
                                            '<div class="col-sm-1 col-md-2" style="margin-top:10px; margin-left:50px; width:80%">' +
                                                '<span class="pull-left">' +
                                                    '<label class="LabelCaption pull-right">Post Date : </label>' +
                                                '</span>' +
                                            '</div>' +
                                             '<div class="col-sm-8 col-md-8" style="margin-top:10px;">' +
                                                    '<span class="pull-left">' +
                                                    '<label class="LabelCaption pull-right">' + e[i].listDetail[j].PostDate + '</label>' +
                                                    '</span>' +
                                            '</div>' +
                                        '</div>' +
                                '</div>' 
                         
                        }
                        else {
                            html += 
                                '<div id="div" style="border-width:thin; border-style:solid; margin-left:5px; display:block; margin-top: 20px; margin-bottom:20px; width:99%;display:block">' +
                                '<div class="row form-group">' +
                                '<div class="col-sm-11 col-md-11" style="margin-top:20px; margin-left:50px; width:80%">' +
                                //'<textarea id="txtTopicDetail_' + i + '" name="txtTopicDetail_' + i + '" rows="10" style="width:100%"> </textarea>' +
                                '<label class="LabelCaption pull-right">'+ e[i].listDetail[j].PostDetail +'</label>' +
                                '</div>' +
                                '</div>' +
                                '<div class="row form-group">' +
                                '<div class="col-sm-6 col-md-6" style="margin-top:10px; margin-left:50px; width:80%">' +
                                '<span class="pull-right">' +
                                '<label class="LabelCaption pull-right">File Attach : </label>' +
                                '</span>' +
                                '</div>' +
                                '<div class="col-sm-4 col-md-4" style="margin-top:10px; width:80%">' +
                                '<span class="pull-left">' +
                                '<a href="'+ e[i].listDetail[j].AttachFilePath + '">' + e[i].listDetail[j].AttachFileName + '</a>' + 
                                '</span>' +
                                '</div>' +
                                '</div>' +
                                '<div class="row form-group">' +
                                '<div class="col-sm-6 col-md-6" style="margin-top:10px; margin-left:50px; width:80%">' +
                                '<span class="pull-right">' +
                                '<label class="LabelCaption pull-left">Post Date : </label>' +
                                '</span>' +
                                '</div>' +
                                '<div class="col-sm-4 col-md-4" style="margin-top:10px;">' +
                                '<span class="pull-left">' +
                                '<label class="LabelCaption pull-left">' + e[i].listDetail[j].PostDate + '</label>' +
                                '</span>' +
                                '</div>' +
                                '</div>' +
                                '</div>'
                        }

                    }
                html += '</div>'
            }

             $("#divHeader").append(html);
        }

    </script>

}