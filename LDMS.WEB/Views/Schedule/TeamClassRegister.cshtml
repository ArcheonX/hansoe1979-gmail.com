
@{
    ViewData["Title"] = "ClassRegister";
    ViewData["MainTitle"] = "My-Team Class Register";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@model LDMS.ViewModels.LDMS_M_Course;
<div class="panel panel-primary" style="margin-top:-15px;width:100%;">
    <div class="panel panel-default" style="width:100%;border-width:thin;border-style:solid;">
        <div class="panel-body" style="width:100%;">
            <form id="frmMain" class="form" method="post" enctype="multipart/form-data" style="width:100%">
                @Html.AntiForgeryToken()
                @if (Model != null)
                {
                    <input type="hidden" id="hID" name="hID" value=@Model.ID />

                }
                else
                {
                    <input type="hidden" id="hID_CoachingReviewHead" name="hID_CoachingReviewHead" value="" />
                }
                <div class="form-horizontal" style="margin-top:25px">
                    <div class="row form-group">
                        <div class="col-sm-2 col-md-2"  style="margin-left:10px; margin-top:20px">
                            <span class="pull-left">
                                <label class="LabelCaption" style="font-weight:bold;">My Class-Schedule</label>
                            </span>
                        </div>
                    </div>
                    <dvi class="row form-group">
                        <div class="col-sm-1 col-md-1 offset-1" style="margin-top:20px">
                            <span class="pull-left">
                                <label class="LabelCaption" style="font-weight:bold;">Keyword : </label>
                            </span>
                        </div>
                        <div class="col-sm-3 col-md-3" style="margin-top:20px; margin-left:-20px">
                            <input type="text" id="txtKeyword" name="txtKeyword"
                                   class="form-control" placeholder="Please Key Enter" />
                        </div>
                        <div class="col-sm-2 col-md-2" style="margin-top:20px; margin-left:-20px">
                            <a id="btnSearch" class="btn btn-outline-secondary waves-effect waves-light" style="width:70%;" onclick="LoadTeamClassList();">
                                <img style="width:25px;height:20px" src="~/assets/images/svg/icon-seach.svg" />&nbsp;&nbsp;Search
                            </a>
                        </div>
                        <div class="col-sm-2 col-md-2 offset-1" style="margin-top:20px;">
                            <a id="btnSubmit" class="btn btn-outline-primary waves-effect waves-light" style="width:70%;" onclick="SubmitClassRegisterApprove();">
                                <img style="width:25px;height:20px" src="~/assets/images/svg/right.svg" />&nbsp;&nbsp;Submit
                            </a>
                        </div>
                        <div class="col-sm-2 col-md-2" style="margin-top:20px; margin-left:-60px">
                            <a id="btnReject" class="btn btn-outline-danger inactive waves-effect waves-light" style="width:70%;" onclick="SubmitClassRegisterReject()">
                                <img style="width:25px;height:20px" src="~/assets/images/svg/icon-l-red.svg" />&nbsp;&nbsp;Reject
                            </a>
                        </div>
                    </dvi>

                </div>
                <div style="border-width:thin; border-style:solid; margin-left:0px; margin-top: 15px; margin-bottom:5px; width:100%;display:block"></div>

                <div id="divScheduleRender" style="display:block">
                    <div class="table-responsive m-t-40">
                        <table class="display dataTable bJQueryUI" width="100%" id="dtClass">
                            <thead>
                                <tr>
                                    <th style="text-align:center;width:50px">
                                        <input type='checkbox'
                                               name='selectClass_all'
                                               value='selectClass_all'
                                               id="selectClass_all" style="color:white;"
                                               onclick="checkClassAll(this)" /><label for="selectClass_all" style="top:5px"> </label>
                                    </th>
                                    <th style="text-align:center">Platform</th>
                                    <th style="text-align:center">SubPlatform</th>
                                    <th style="text-align:center">Course</th>
                                    <th style="text-align:center">Content</th>
                                    <th style="text-align:center">Training Date</th>
                                    <th style="text-align:center">Training Time</th>
                                    <th style="text-align:center">Venue</th>
                                    <th style="text-align:center">Requester</th>
                                    <th style="text-align:center">Job Title</th>
                                    <th style="text-align:center">Remark</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

            </form>
        </div>
        <div class="modal" id="modCourse" style="padding-top:-25px;" tabindex="-1" role="dialog" aria-labelledby="modAlertLabel" aria-hidden="false" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-lg" style="background-color:white;border-radius:2%;width:150%">
                <div class="modal-content" style="margin-top:100px;width:120%">
                    <div class="modal-header card-header" style="padding-top:0px;">
                        <h4 class="modal-title" id="lblMATiltle">Course Detail</h4>
                    </div>
                    <div class="panel-body">
                        <div class="table-responsive" style="overflow-y:auto; height:550px">
                            <!--<div id="divCourse"></div>-->
                            <div class="form-group row" style="margin-top:20px">
                                <div class="col-sm-2 col-md-2">
                                    <span class="pull-right">
                                        <label class="LabelCaption">Platform</label>
                                    </span>

                                </div>
                                <div class="col-sm-2 col-md-9">
                                    <input type="text"
                                           id="txtPlatform"
                                           style="width: 100%"
                                           class="form-control input-sm"
                                           disabled="disabled" />
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-sm-2 col-md-2">
                                    <span class="pull-right">
                                        <label class="LabelCaption">Course Name</label>
                                    </span>

                                </div>
                                <div class="col-sm-2 col-md-9">
                                    <input type="text"
                                           id="txtCourseName"
                                           style="width: 100%"
                                           class="form-control input-sm"
                                           disabled="disabled" />
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-sm-2 col-md-2">
                                    <span class="pull-right">
                                        <label class="LabelCaption">Description</label>
                                    </span>

                                </div>
                                <div class="col-sm-2 col-md-9">
                                    <textarea id="txtDescription"
                                              rows="4"
                                              class="form-control input-sm"
                                              style="width:100%"
                                              disabled="disabled"></textarea>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-sm-2 col-md-2">
                                    <span class="pull-right">
                                        <label class="LabelCaption">Objective</label>
                                    </span>

                                </div>
                                <div class="col-sm-2 col-md-9">
                                    <textarea id="txtObjective"
                                              rows="4"
                                              class="form-control input-sm"
                                              style="width:100%"
                                              disabled="disabled"></textarea>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-sm-2 col-md-2">
                                    <span class="pull-right">
                                        <label class="LabelCaption">Outline</label>
                                    </span>

                                </div>
                                <div class="col-sm-2 col-md-9">
                                    <textarea id="txtOutline"
                                              rows="4"
                                              class="form-control input-sm"
                                              style="width:100%"
                                              disabled="disabled"></textarea>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="row form-group" style="align-items:center">
                        <!--<div class="col-sm-1 col-md-2 offset-10" style="margin-left:20rem; margin-top:20px">
                            <a id="btnRegister" class="btn btn-outline-primary waves-effect waves-light" style="width:100%;" onclick="OpenCourseModal()">
                                <img style="width:25px;height:20px" src="~/assets/images/svg/right.svg" /> Register </a>
                        </div>-->
                        <div class="col-sm-1 col-md-2 offset-5" style="margin-top:20px">
                            <a id="btnClose" class="btn btn-outline-danger inactive waves-effect waves-light" style="width:90%;" onclick="CloseCourseModal()">
                                <img style="width:25px;height:20px" src="~/assets/images/svg/icon-l-red.svg" />&nbsp;&nbsp;Back
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts{
    <style type="text/css">
        .form-group {
            position: relative;
            background-size: cover;
            margin-bottom: 1.5rem;
        }
    </style>
    <script type="text/javascript">
        $(document).ready(function () {

            LoadTeamClassList();

        });

        function checkClassAll(e) {
            if (e.checked) {
                $(".chkSingle").each(function () {
                    if (!this.checked) { this.checked = true; }
                });
            }
            else {
                $(".chkSingle").each(function () {
                    if (this.checked) { this.checked = false; }
                });
            }
        }

        function LoadTeamClassList() {

            MessageController.BlockUI({ boxed: true, target: '#frmMain' });
            $.ajax(
                {
                    url: "/Schedule/GetTeamClassRegister",
                    type: "POST",
                    data: {
                        ID_Department: CookiesController.getCookie("DEPARTMENTID"),
                        Keyword: $('#txtKeyword').val(),
                    },
                    success: function (e) {
                        
                        RenderTeamClassList(e);

                    },
                }
            )

        }

        function RenderTeamClassList(e) {
            var html = '';
            //alert('RenderClassList ' + e.length);
            $("#dtClass tbody > tr").remove();

            for (var i = 0; i < e.length; i++) {
                var row = $("<tr />");
                $("#dtClass tbody").append(row);
                
                row.append('<input type="hidden" id="hdSelect_ID_Class_' + i + '" name="hdSelect_ID_Class_' + i + '" value="' + e[i].ID_Class + '" />');
                row.append('<input type="hidden" id="hdSelect_ID_Course_' + i + '" name="hdSelect_ID_Course_' + i + '" value="' + e[i].ID_Course + '" />');
                row.append('<input type="hidden" id="hdSelect_ID_Employee_' + i + '" name="hdSelect_ID_Employee_' + i + '" value="' + e[i].EmployeeID + '" />');
                row.append('<td style="text-align:center"><input type="checkbox" class="chkSingle" style="text-align:center; name="selectClass_' + i + '" value="selectClass_' + i + '" id="selectClass_' + i + '"/><label for="selectClass_' + i + '"> </label> </td>');
                row.append('<td style="text-align:center">' + e[i].PlatformName_EN + '</td>');
                row.append('<td style="text-align:center">' + e[i].SubPlatformName_EN + '</td>');
                row.append('<td style="text-align:center">' + e[i].CourseName + '</a></td>');
                row.append('<td style="text-align:center"><img src=@Url.Content("~/assets/images/png/info.png") width=60 heigth=60 class="btn" onclick="OpenCourseModal('+ e[i].ID_Course + ');"></img></td>');
                row.append('<td style="text-align:center">' + e[i].LearnDateStart + '</td>');
                row.append('<td style="text-align:center">' + e[i].Time + '</td>');
                row.append('<td style="text-align:center">' + e[i].RoomName_EN + '</td>');
                row.append('<td style="text-align:center">' + e[i].Requester + '</td>');
                row.append('<td style="text-align:center">' + e[i].JobTitleName_EN + '</td>');
                
                row.append('<td style="text-align:center; margin-top:-10px"><input type="text" id="txtRemark_' + i + '" name="txtRemark_' + i + '" value=""  class="form-control input-sm"  /></td>');
                //row.append('<td style="text-align:center">' + e[i].RemarkAdmin + '</td>');

            }

           

               /*if ($.fn.dataTable.isDataTable('#dtClass')) {
                    var table = $('#dtClass').DataTable();
                    table.destroy();
                }*/
                $('#dtClass').DataTable({
                    'processing': true,
                    'paging': false,
                    "ordering": false,
                    "searching": false,
                    "lengthChange": false,
                    "bAutoWidth": false,
                    "Filter": false,
                    "info": false,
                    "bPaginate": false,
                    "bLengthChange": false,
                    "pageLength": 10,
                    "bJQueryUI": true, //Enable smooth theme
                    "sPaginationType": "full_numbers", //Enable smooth theme
                    "sDom": 'lfrtip',
                });
                $('.dataTables_length').addClass('bs-select');
               MessageController.UnblockUI('#frmMain');
        }

        function OpenCourseModal(ID_Course) {
            //alert('Course : ' + ID_Course);
            $.ajax(
                    {
                        url: "/Schedule/GetCourseInfo",
                        type: "POST",
                        data: {
                            'ID_Course' : ID_Course
                    },
                    success: function (e) {
                        //RenderCourseDetail(e);
                        $('#txtPlatform').val(e.PlatformName_EN);
                        $('#txtCourseName').val(e.CourseName);
                        $('#txtDescription').val(e.Description);
                        $('#txtObjective').val(e.Objective);
                        $('#txtOutline').val(e.Outline);
                        $('#modCourse').modal('toggle');
                    },
                }
            )
        }

        function CloseCourseModal() {
             $('#modCourse').modal('hide');
        }


      function SubmitClassRegisterApprove() {
        
        var model = [];
        var i = 0;
        var count = 0;
        var  idcourse = '';
        while ($("#selectClass_" + i).val() === ("selectClass_" + i)) {
            if ($("#selectClass_" + i).prop("checked")) {
                var obj = {
                    ID_Class: $("#hdSelect_ID_Class_" + i).val(),
                    ID_Course: $("#hdSelect_ID_Course_" + i).val(),
                    ID_Employee : $("#hdSelect_ID_Employee_" + i).val()
                };

                /*if (i > 0) {
                    if ($("#hdSelect_ID_Course_" + (i - 1)).val() == idcourse) {
                        count++;
                    }
                }*/

                model.push(obj);
                //idcourse = $("#hdSelect_ID_Course_" + i).val();
            }
            i++;
          }
          alert(JSON.stringify(model));
          if (count > 0) {
              alert('กรุณาเลือกรายการ course ที่ไม่ซ้ำกัน !!!!');
          }
          else {
               
                $.ajax({
                    url: "/Schedule/UpdateRegisStatusA",
                    type: "POST",
                    data: {
                        'model': JSON.stringify(model)
                    },
                    success: function (e) {
                        // window.location.href = '@Url.Content("~/Schedule/Schedule/")';
                        LoadTeamClassList();
                    },

                });
          }



        return false;
        }


     function SubmitClassRegisterReject() {
        
        var model = [];
        var i = 0;
        var count = 0;
        var  idcourse = '';
        while ($("#selectClass_" + i).val() === ("selectClass_" + i)) {
            if ($("#selectClass_" + i).prop("checked")) {
                var obj = {
                    ID_Class: $("#hdSelect_ID_Class_" + i).val(),
                    ID_Course: $("#hdSelect_ID_Course_" + i).val(),
                    ID_Employee: $("#hdSelect_ID_Employee_" + i).val(),
                    Remark : $("#txtRemark_" + i).val()
                };

                /*if (i > 0) {
                    if ($("#hdSelect_ID_Course_" + (i - 1)).val() == idcourse) {
                        count++;
                    }
                }*/

                model.push(obj);
                //idcourse = $("#hdSelect_ID_Course_" + i).val();
            }
            i++;
          }
          alert(JSON.stringify(model));
          if (count > 0) {
              alert('กรุณาเลือกรายการ course ที่ไม่ซ้ำกัน !!!!');
          }
          else {
               
                $.ajax({
                    url: "/Schedule/UpdateRegisStatusR",
                    type: "POST",
                    data: {
                        'model': JSON.stringify(model)
                    },
                    success: function (e) {
                         //window.location.href = '@Url.Content("~/Schedule/TeamSchedule/")';
                        LoadTeamClassList();

                    },

                });
          }



        return false;
    }

    </script>
}